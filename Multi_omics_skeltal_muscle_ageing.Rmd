---
title: "meta_analysis_hf<=5_c"
output: html_document
date: "2023-07-14"
---
```{r packages, message=FALSE, warning=FALSE, echo=TRUE}
suppressPackageStartupMessages({
library("purrr")
library("metafor")
library("dplyr")
library("readxl")
library("ggplot2")
library("tidyverse")
library("readr")
library("DESeq2")
library("dplyr")
library("stringr")
library("biomaRt")
  
  
  
})
```

```{r DNAm, message=FALSE, warning=FALSE, echo=TRUE}
skeletal_muscle<-read_delim("/mnt/vol1/EWAS_BACONNED/muscle/muscle/muscle_obese/metafor_muscle_HetDf>=2.txt")
annotation<-read_csv("/mnt/vol1/annotation_latest_symbols_updated.csv")

annotation <- annotation %>%
  rename(CpG = probeID)

dnam_annot <- skeletal_muscle %>%
  inner_join(annotation, by = "CpG") %>%
  filter(!is.na(gene_symbols), gene_symbols != "")

# If gene_symbols has multiple genes separated by ; or ,
dnam_long <- dnam_annot %>%
  mutate(gene_symbols = gsub("\\s+", "", gene_symbols)) %>%
  separate_rows(gene_symbols, sep = ";|,") %>%  
  filter(gene_symbols != "")

#Make the cpg counts in gene level
dnam_gene <- dnam_long %>%
  group_by(gene = gene_symbols) %>%
  summarise(
    n_cpg        = n(),
    mean_ES_RE   = mean(ES_RE, na.rm = TRUE),
    median_ES_RE = median(ES_RE, na.rm = TRUE),
    min_pval     = min(pval_RE, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate(
    FDR_gene = p.adjust(min_pval, method = "BH")
  )

dnam_gene %>% arrange(FDR_gene) %>% head()
dim(dnam_gene)


write.csv(
  dnam_gene,
  "/mnt/vol1/Multi-omics-skeletal-muscle-ageing/dnam_muscle_age_genes.csv",
  row.names = FALSE
)


```

```{r gtex, message=FALSE, warning=FALSE, echo=TRUE}

# GTEx skeletal muscle counts (v8)
if (! file.exists("/mnt/vol1/enrichment/ske/gene_reads_2017-06-05_v8_muscle_skeletal.gct.gz") ) {
  download.file("https://storage.googleapis.com/adult-gtex/bulk-gex/v8/rna-seq/counts-by-tissue/gene_reads_2017-06-05_v8_muscle_skeletal.gct.gz",
    destfile="/mnt/vol1/enrichment/ske/gene_reads_2017-06-05_v8_muscle_skeletal.gct.gz")
}

gtex_tisue <- read.table("/mnt/vol1/enrichment/ske/gene_reads_2017-06-05_v8_muscle_skeletal.gct.gz", header = TRUE, sep = "\t", skip = 2,check.names = FALSE)

gene_info <- gtex_tisue[, 1:2]
expr_counts <- as.matrix(gtex_tisue[, -c(1, 2)])

rownames(expr_counts) <- gene_info$Name
head(rownames(expr_counts))

expr_counts <- expr_counts[, colnames(expr_counts) != "Description"]
head(colnames(expr_counts))


# Sample attributes
if (!file.exists("/mnt/vol1/enrichment/ske/GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt")) {
  download.file(
    "https://storage.googleapis.com/adult-gtex/annotations/v8/metadata-files/GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt",
    destfile = "/mnt/vol1/Multi-omics-skeletal-muscle-ageing/GTEx_sample_attr_file.txt"
  )
}

# Subject phenotypes
if (!file.exists("/mnt/vol1/enrichment/ske/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.txt")) {
  download.file(
    "https://storage.googleapis.com/adult-gtex/annotations/v8/metadata-files/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.txt",
    destfile = "/mnt/vol1/Multi-omics-skeletal-muscle-ageing/GTEx_subject_pheno_file.txt"
  )
}

sample_annot_gtex  <- read.delim("/mnt/vol1/Multi-omics-skeletal-muscle-ageing/GTEx_sample_attr_file.txt",  stringsAsFactors = FALSE)

subject_annot_gtex <- read.delim("/mnt/vol1/Multi-omics-skeletal-muscle-ageing/GTEx_subject_pheno_file.txt", stringsAsFactors = FALSE)


# Only Muscle - Skeletal samples
sample_muscle <- sample_annot_gtex %>%
  dplyr::filter(SMTSD == "Muscle - Skeletal")


subject_annot_gtex <- subject_annot_gtex %>%
  select(SUBJID, AGE, SEX)

# Modify the column name and the row names of sample muscle

sample_muscle <- sample_annot_gtex %>%
  filter(SMTSD == "Muscle - Skeletal") %>%
  mutate(
    # donor ID = first two chunks of SAMPID, e.g. GTEX-1117F
    SUBJID = vapply(
      strsplit(SAMPID, "-"),
      function(x) paste(x[1:2], collapse = "-"),
      character(1)
    )
  )

subject_small <- subject_annot_gtex %>%
  select(SUBJID, AGE, SEX)

pheno_muscle <- sample_muscle %>%
  left_join(subject_small, by = "SUBJID")

pheno_muscle %>%
  select(SAMPID, SUBJID, SMTSD, AGE, SEX) %>%
  head()


samples_expr <- colnames(expr_counts)
pheno_muscle2 <- pheno_muscle %>%
  filter(SAMPID %in% samples_expr)

pheno_muscle2 <- pheno_muscle2[
  match(samples_expr, pheno_muscle2$SAMPID),
]


```

```{r rnaseq, message=FALSE, warning=FALSE, echo=TRUE}

ids_expr  <- colnames(expr_counts)
ids_pheno <- pheno_muscle2$SAMPID
common_ids <- intersect(ids_expr, ids_pheno)
expr_counts_aligned  <- expr_counts[, common_ids]
#Trim any stray spaces
expr_counts_aligned <- trimws(expr_counts_aligned)

expr_counts_aligned <- matrix(
  as.numeric(expr_counts_aligned),
  nrow = nrow(expr_counts_aligned),
  ncol = ncol(expr_counts_aligned),
  dimnames = dimnames(expr_counts_aligned)
)


mode(expr_counts_aligned)

summary(as.vector(expr_counts_aligned))[1:6]
min(expr_counts_aligned, na.rm = TRUE)
any(expr_counts_aligned < 0, na.rm = TRUE)


pheno_muscle_aligned <- pheno_muscle2 %>%
  dplyr::filter(SAMPID %in% common_ids) %>%
  dplyr::arrange(match(SAMPID, common_ids))

pheno_muscle_aligned$AGE_ord <- as.numeric(factor(
  pheno_muscle_aligned$AGE,
  levels  = c("20-29","30-39","40-49","50-59","60-69","70-79"),
  ordered = TRUE
))

pheno_muscle_aligned <- pheno_muscle_aligned[!is.na(pheno_muscle_aligned$AGE_ord), ]

rownames(pheno_muscle_aligned) <- pheno_muscle_aligned$SAMPID

dds <- DESeqDataSetFromMatrix(
  countData = expr_counts_aligned,
  colData   = pheno_muscle_aligned,
  design    = ~ AGE_ord
)

head(rownames(dds))


keep<- rowSums(counts(dds)) >= 10
dds<- dds[keep, ]
dds <- DESeq(dds)
plotDispEsts(dds)

norm_counts<- counts(dds, normalized = TRUE)
glimpse(norm_counts)

vsd<- vst(dds, blind = TRUE)
vsd_mat<- assay(vsd)
vsd_mat_scaled <- t(scale(t(vsd_mat)))

ann <- as.data.frame(colData(vsd))[, c("AGE"), drop = FALSE]
ord_cols <- order(vsd$AGE_ord)

# sample–sample correlation heatmap
pheatmap::pheatmap(
  cor(assay(vsd)),
  annotation_col = ann,
  annotation_row = ann
)


# PCA by age band
DESeq2::plotPCA(vsd, intgroup = c("AGE"))


res_age <- results(dds, name = "AGE_ord", alpha = 0.05)
plotMA(res_age)

rna_gene <- as.data.frame(res_age) %>%
  rownames_to_column("gene") %>%
  transmute(
    gene,
    beta_age_rna = log2FoldChange,  
    p_rna        = pvalue,
    FDR_rna      = padj
  )

write.csv(
  rna_gene,
  "/mnt/vol1/Multi-omics-skeletal-muscle-ageing/rna_muscle_age_genes_deseq.csv",
  row.names = FALSE
)

```


```{r DNAM_RNA_MULTI_p1, message=FALSE, warning=FALSE, echo=TRUE}

dnam_gene <- read.csv("/mnt/vol1/Multi-omics-skeletal-muscle-ageing/dnam_muscle_age_genes.csv")
rna_gene  <- read.csv("/mnt/vol1/Multi-omics-skeletal-muscle-ageing/rna_muscle_age_genes_deseq.csv")


rna_gene2 <- rna_gene %>%
  mutate(ensembl_id = str_replace(gene, "\\.\\d+$", ""))

# biomaRt mapping (human)
mart <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")

map_tbl <- getBM(
  attributes = c("ensembl_gene_id", "hgnc_symbol"),
  filters    = "ensembl_gene_id",
  values     = unique(rna_gene2$ensembl_id),
  mart       = mart
)

rna_gene_annot <- rna_gene2 %>%
  left_join(map_tbl, by = c("ensembl_id" = "ensembl_gene_id")) %>%
  dplyr::filter(hgnc_symbol != "") %>%
  dplyr::rename(gene_symbol = hgnc_symbol)

dplyr::

multi_gene <- dnam_gene %>%
  dplyr::rename(gene_symbol = gene) %>%
  inner_join(
    rna_gene_annot %>%
      dplyr::select(gene_symbol, beta_age_rna, p_rna, FDR_rna),
    by = "gene_symbol"
  )


```


 AIM 1: Across all overlapping genes, does methylation effect size correlate with expression effect size?
 
 
 Result:

Overall (0.124)
* Across all overlapping genes, DNAm and RNA age effects are weakly but positively correlated.
→ Only ~1.5% of the variance in RNA age effects is explained by DNAm age effects (0.124² ≈ 0.015).

* DNAm-significant genes (0.071)
Among genes with strong DNAm ageing, the correlation with RNA ageing is even smaller.
→ Many DNAm age-hits don’t show clear expression changes in GTEx muscle.

* RNA-significant genes (0.093)
Similar story: genes with strong RNA ageing still only show a small trend with DNAm.

* Both-significant genes (0.106)
Even among “multi-omics hits”, coupling is modest. This is expected:

** not all DNAm changes are regulatory,

** many are in gene bodies/other contexts,

** and RNA is noisier / affected by lots of other layers.

* Any-significant (0.128)
Basically the same as overall – reinforces that global DNAm–RNA coupling is weak.



Final conclusion:

Global: “Ageing methylation and expression changes are only weakly aligned in skeletal muscle (ρ ≈ 0.12).” This is also seen in other studies such as 
https://pmc.ncbi.nlm.nih.gov/articles/PMC3954952/ 
https://pmc.ncbi.nlm.nih.gov/articles/PMC8350206/ 

Next: “Therefore, we focus on the subset of genes with strong evidence in one or both layers, and on pathways enriched for these multi-omics ageing genes.”

```{r DNAM_RNA_MULTI_I, message=FALSE, warning=FALSE, echo=TRUE}



alpha <- 0.05

multi_gene <- multi_gene %>%
  mutate(
    sig_dnam = FDR_gene < alpha,
    sig_rna  = FDR_rna  < alpha
  )

cor_all      <- cor(multi_gene$mean_ES_RE, multi_gene$beta_age_rna, use = "complete.obs")
cor_dnam_sig <- with(subset(multi_gene, sig_dnam), 
                     cor(mean_ES_RE, beta_age_rna, use = "complete.obs"))
cor_rna_sig  <- with(subset(multi_gene, sig_rna),
                     cor(mean_ES_RE, beta_age_rna, use = "complete.obs"))
cor_both_sig <- with(subset(multi_gene, sig_dnam & sig_rna),
                     cor(mean_ES_RE, beta_age_rna, use = "complete.obs"))

cor_all
cor_dnam_sig
cor_rna_sig
cor_both_sig


multi_gene <- multi_gene %>%
  mutate(
    category = case_when(
      sig_dnam & sig_rna ~ "Both DNAm & RNA",
      sig_dnam & !sig_rna ~ "DNAm only",
      !sig_dnam & sig_rna ~ "RNA only",
      TRUE ~ "Neither"
    )
  )

ggplot(multi_gene, aes(x = mean_ES_RE, y = beta_age_rna, colour = category)) +
  geom_point(alpha = 0.5, size = 1) +
  theme_bw() +
  labs(
    x = "DNAm age effect size (mean_ES_RE)",
    y = "RNA age effect size (beta_age_rna)",
    colour = "Significance",
    title = "Gene-level DNAm vs RNA age effects in skeletal muscle"
  )



```
Aim 2 = characterise multi-omics ageing gene categories + directionality

# Significance and define categories

Among 22,791 genes with both DNAm and RNA data, 9,446 (41.4%) were age-associated in both layers (FDR < 0.05), 6,441 (28.3%) only in DNAm, 2,273 (10.0%) only in RNA, and 4,631 (20.3%) were not significant in either modality.

```{r DNAM_RNA_MULTI_II, message=FALSE, warning=FALSE, echo=TRUE}


multi_gene <- multi_gene %>%
  mutate(
    direction_pair = case_when(
      sig_dnam & sig_rna & mean_ES_RE > 0 & beta_age_rna > 0 ~ "Hyper + Up",
      sig_dnam & sig_rna & mean_ES_RE > 0 & beta_age_rna < 0 ~ "Hyper + Down",
      sig_dnam & sig_rna & mean_ES_RE < 0 & beta_age_rna > 0 ~ "Hypo + Up",
      sig_dnam & sig_rna & mean_ES_RE < 0 & beta_age_rna < 0 ~ "Hypo + Down",
      TRUE ~ "Other"
    )
  )

table(multi_gene$direction_pair)

alpha_dnam <- 0.05
alpha_rna  <- 0.05

multi_gene <- multi_gene %>%
  mutate(
    sig_dnam = FDR_gene < alpha_dnam,
    sig_rna  = FDR_rna  < alpha_rna,
    category = dplyr::case_when(
      sig_dnam & sig_rna  ~ "Both DNAm & RNA",
      sig_dnam & !sig_rna ~ "DNAm only",
      !sig_dnam & sig_rna ~ "RNA only",
      TRUE                ~ "Neither"
    )
  )

tab_cat <- multi_gene %>%
  dplyr::group_by(category) %>%
  dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%
  dplyr::mutate(prop = n / sum(n))

tab_cat

```

Directionality within “both” genes

Among the 9,446 genes significant in both DNAm and RNA, 3,778 (40.0%) showed an inverse relationship between DNAm and expression with age (Hyper+Down or Hypo+Up), whereas 5,668 (60.0%) showed same-direction changes (Hyper+Up or Hypo+Down), consistent with context-dependent effects of methylation on transcription.


```{r DNAM_RNA_MULTI_p, message=FALSE, warning=FALSE, echo=TRUE}

multi_gene <- multi_gene %>%
  mutate(
    dir_pair = case_when(
      sig_dnam & sig_rna & mean_ES_RE > 0 & beta_age_rna > 0 ~ "Hyper + Up",
      sig_dnam & sig_rna & mean_ES_RE > 0 & beta_age_rna < 0 ~ "Hyper + Down",
      sig_dnam & sig_rna & mean_ES_RE < 0 & beta_age_rna > 0 ~ "Hypo + Up",
      sig_dnam & sig_rna & mean_ES_RE < 0 & beta_age_rna < 0 ~ "Hypo + Down",
      TRUE ~ NA_character_
    ),
    dir_pair = factor(
      dir_pair,
      levels = c("Hyper + Down", "Hypo + Up", "Hyper + Up", "Hypo + Down")
    )
  )

table(multi_gene$dir_pair, useNA = "ifany")




```

# Correlation by category

The correlation between DNAm and RNA age effects was strongest among genes significant in both layers (Spearman ρ = 0.20), weaker among DNAm-only (ρ = 0.08) and RNA-only (ρ = 0.03) genes, and essentially null in genes not significant in either layer (ρ = −0.02). This indicates that the global DNAm–RNA coupling is driven primarily by a subset of multi-omics ageing genes

```{r DNAM_RNA_MULTI_p, message=FALSE, warning=FALSE, echo=TRUE}

cors_by_cat <- multi_gene %>%
  group_by(category) %>%
  summarise(
    n = sum(!is.na(mean_ES_RE) & !is.na(beta_age_rna)),
    cor_spearman = cor(mean_ES_RE, beta_age_rna,
                       use = "complete.obs", method = "spearman")
  )

cors_by_cat



```


```{r, message=FALSE, warning=FALSE, echo=TRUE}
sessionInfo()
```

